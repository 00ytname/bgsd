<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Blogger í¬ìŠ¤íŒ… ë„êµ¬</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input, select { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>ğŸ“¤ Blogger ìë™ í¬ìŠ¤íŒ…</h2>

  <label>ì œëª©:</label><br>
  <input id="postTitle" placeholder="ê²Œì‹œë¬¼ ì œëª©" style="width: 400px;"><br><br>

  <label>ì¢…ë¥˜ ì„ íƒ:</label><br>
  <input type="radio" name="mediaType" value="image" checked> ì´ë¯¸ì§€
  <input type="radio" name="mediaType" value="video"> ë™ì˜ìƒ<br><br>

  <div id="imageOptions">
    <label>ì´ë¯¸ì§€ ë°©ì‹:</label><br>
    <input type="radio" name="imageMode" value="original" checked> ì›ë³¸ ë§í¬
    <input type="radio" name="imageMode" value="imgur"> Imgur ë³€í™˜<br><br>
  </div>

  <div id="videoOptions" style="display:none;">
    <label>ë™ì˜ìƒ ë°©ì‹:</label><br>
    <input type="radio" name="videoMode" value="original" checked> ì›ë³¸ ë§í¬
    <input type="radio" name="videoMode" value="imgur"> Imgur ë³€í™˜<br><br>
  </div>

  <label>ë§í¬ ì…ë ¥ (ì—¬ëŸ¬ ì¤„ ê°€ëŠ¥):</label><br>
  <textarea id="mediaUrls" rows="6" cols="60" placeholder="https://example.com/abc.mp4 ë˜ëŠ” https://imgur.com/abc ë“±"></textarea><br>

  <button onclick="createBloggerPost()">ğŸ“ ê²Œì‹œë¬¼ ì‘ì„±</button>
  <div id="postStatus" style="margin-top:20px; color:blue;"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const accessToken = params.get("token");

    const mediaTypeRadios = document.getElementsByName("mediaType");
    const videoOptions = document.getElementById("videoOptions");
    const imageOptions = document.getElementById("imageOptions");

    mediaTypeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        const isVideo = radio.value === "video";
        videoOptions.style.display = isVideo ? "block" : "none";
        imageOptions.style.display = isVideo ? "none" : "block";
      });
    });

function getVideoHtml(url, mode) {
  let src = url.trim();
  let thumbImg = "";

  if (mode === "imgur") {
    const match = src.match(/imgur\.com\/([a-zA-Z0-9]+)/);
    if (match) {
      const code = match[1];
      src = `https://i.imgur.com/${code}.mp4`;
      thumbImg = `<p style="text-align:center; margin: 20px 0;">
                    <img src="https://i.imgur.com/${code}.jpeg" style="max-width:500px;">
                  </p>`;
    }
  } else {
    // ğŸ‘‡ ì—¬ê¸° ì¶”ê°€: ì›ë³¸ì¼ ë•Œ ì¸ë„¤ì¼ ìë™ì¶”ì •
    if (src.endsWith(".mp4")) {
      const thumbUrl = src.replace(".mp4", ".jpg"); // ë˜ëŠ” .jpeg
      thumbImg = `<p style="text-align:center; margin: 20px 0;">
                    <img src="${thumbUrl}" style="max-width:500px;">
                  </p>`;
    }
  }

  const videoTag = `<p style="text-align:center; margin: 20px 0;">
                      <video src="${src.replace(/&/g, "&amp;")}" controls preload="metadata" muted style="max-height:500px;"></video>
                    </p>`;

  return thumbImg + videoTag;
}


    async function getBlogId(token) {
      const res = await fetch("https://www.googleapis.com/blogger/v3/users/self/blogs", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();
      return data.items[0].id;
    }

    async function createBloggerPost() {
      const title = document.getElementById("postTitle").value.trim();
      const urls = document.getElementById("mediaUrls").value.trim().split("\n").filter(line => line.trim() !== "");
      const mediaType = [...document.getElementsByName("mediaType")].find(r => r.checked).value;
      const videoMode = [...document.getElementsByName("videoMode")].find(r => r.checked)?.value;
      const imageMode = [...document.getElementsByName("imageMode")].find(r => r.checked)?.value;

      if (!title || urls.length === 0) {
        alert("ì œëª©ê³¼ ë§í¬ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      if (!accessToken) {
        alert("âŒ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. login.htmlì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        return;
      }

      const blogId = await getBlogId(accessToken);
      let contentHtml = "";

      for (const url of urls) {
        if (mediaType === "image") {
          contentHtml += getImageHtml(url.trim(), imageMode);
        } else {
          contentHtml += getVideoHtml(url.trim(), videoMode);
        }
      }

      const postData = { title: title, content: contentHtml };

      const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(postData)
      });

      const result = await res.json();

      if (result.id) {
        document.getElementById("postStatus").innerHTML =
          `âœ… ê²Œì‹œ ì„±ê³µ! <a href="${result.url}" target="_blank">ğŸ”— ê²Œì‹œë¬¼ ë³´ê¸°</a>`;
      } else {
        document.getElementById("postStatus").innerText = "âŒ ê²Œì‹œ ì‹¤íŒ¨";
        console.error(result);
      }
    }
  </script>
</body>
</html>
