<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Blogger í¬ìŠ¤íŒ… ë„êµ¬</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; }
    textarea, input, select, button { margin: 5px 0; padding: 5px; }
    .link-group { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
    .link-group input { flex: 1; }
    .link-label { font-weight: bold; margin-top: 15px; }
    #thumbnailInput { display: none; }
    .btn-add { margin-top: 5px; }
  </style>
</head>
<body>
  <h2>ğŸ“¤ Blogger ìë™ í¬ìŠ¤íŒ…</h2>

  <label>ì œëª©:</label><br>
  <input id="postTitle" placeholder="ê²Œì‹œë¬¼ ì œëª©" style="width: 100%;"><br><br>

  <label>ì¢…ë¥˜ ì„ íƒ:</label><br>
  <input type="radio" name="mediaType" value="image" checked> ì´ë¯¸ì§€
  <input type="radio" name="mediaType" value="video"> ë™ì˜ìƒ<br><br>

  <div id="imageOptions">
    <label>ì´ë¯¸ì§€ ë°©ì‹:</label><br>
    <input type="radio" name="imageMode" value="original" checked> ì›ë³¸ ë§í¬
    <input type="radio" name="imageMode" value="imgur"> Imgur ë³€í™˜<br><br>
  </div>

  <div id="videoOptions" style="display:none;">
    <label>ë™ì˜ìƒ ë°©ì‹:</label><br>
    <input type="radio" name="videoMode" value="original" checked> ì›ë³¸ ë§í¬
    <input type="radio" name="videoMode" value="imgur"> Imgur ë³€í™˜<br><br>

    <div id="thumbnailInput">
      <label>ì¸ë„¤ì¼ ì´ë¯¸ì§€ ì£¼ì†Œ (ì„ íƒ):</label><br>
      <input id="manualThumbnailUrl" placeholder="https://example.com/thumb.jpg" style="width: 100%;"><br><br>
    </div>
  </div>

  <div class="link-label">ë§í¬ ëª©ë¡:</div>
  <div id="linkList"></div>
  <button class="btn-add" onclick="addInput('image')">+ ì´ë¯¸ì§€ ì¶”ê°€</button>
  <button class="btn-add" onclick="addInput('video')">+ ë™ì˜ìƒ ì¶”ê°€</button><br><br>

  <button onclick="createBloggerPost()">ğŸ“ ê²Œì‹œë¬¼ ì‘ì„±</button>
  <div id="postStatus" style="margin-top:20px; color:blue;"></div>

  <script>
    const accessToken = new URLSearchParams(window.location.search).get("token");

    const linkListDiv = document.getElementById("linkList");

    function addInput(type) {
      const div = document.createElement("div");
      div.className = "link-group";
      div.dataset.type = type;
      div.innerHTML = `
        <span>${type === "image" ? "ğŸ–¼ï¸" : "ğŸï¸"}</span>
        <input type="text" placeholder="https://example.com/..." />
        <button onclick="this.parentElement.remove()">âŒ</button>
      `;
      linkListDiv.appendChild(div);
    }

    const mediaTypeRadios = document.getElementsByName("mediaType");
    const videoModeRadios = document.getElementsByName("videoMode");
    const imageOptions = document.getElementById("imageOptions");
    const videoOptions = document.getElementById("videoOptions");
    const thumbnailInput = document.getElementById("thumbnailInput");

    mediaTypeRadios.forEach(r => r.addEventListener("change", updateUI));
    videoModeRadios.forEach(r => r.addEventListener("change", updateUI));

    function updateUI() {
      const mediaType = [...mediaTypeRadios].find(r => r.checked).value;
      const videoMode = [...videoModeRadios].find(r => r.checked)?.value;

      imageOptions.style.display = mediaType === "image" ? "block" : "none";
      videoOptions.style.display = mediaType === "video" ? "block" : "none";
      thumbnailInput.style.display = (mediaType === "video" && videoMode === "original") ? "block" : "none";
    }

    function getImageHtml(url, mode) {
      let src = url.trim();
      if (mode === "imgur") {
        const match = src.match(/imgur\.com\/([a-zA-Z0-9]+)/);
        if (match) src = `https://i.imgur.com/${match[1]}.jpeg`;
      }
      return `<p style="text-align:center; margin: 20px 0;"><img src="${src}" style="max-width:500px;"></p>`;
    }

    function getVideoHtml(urls, mode, manualThumb) {
      let html = "";
      let isFirst = true;

      for (const url of urls) {
        let src = url.trim();
        let thumbImg = "";

        if (mode === "imgur") {
          const match = src.match(/imgur\.com\/([a-zA-Z0-9]+)/);
          if (match) {
            const code = match[1];
            src = `https://i.imgur.com/${code}.mp4`;
            if (isFirst) {
              thumbImg = `<p style="text-align:center; margin: 20px 0;">
                            <img src="https://i.imgur.com/${code}.jpeg" style="max-width:500px;">
                          </p>`;
              isFirst = false;
            }
          }
        } else {
          if (isFirst && manualThumb) {
            thumbImg = `<p style="text-align:center; margin: 20px 0;">
                          <img src="${manualThumb}" style="max-width:500px;">
                        </p>`;
            isFirst = false;
          }
        }

        const videoTag = `<p style="text-align:center; margin: 20px 0;">
                            <video src="${src.replace(/&/g, "&amp;")}" controls preload="metadata" muted style="max-height:500px;"></video>
                          </p>`;
        html += thumbImg + videoTag;
      }

      return html;
    }

    async function getBlogId(token) {
      const res = await fetch("https://www.googleapis.com/blogger/v3/users/self/blogs", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();
      return data.items[0].id;
    }

    async function createBloggerPost() {
      const title = document.getElementById("postTitle").value.trim();
      const manualThumb = document.getElementById("manualThumbnailUrl").value.trim();
      const videoMode = [...document.getElementsByName("videoMode")].find(r => r.checked)?.value;
      const imageMode = [...document.getElementsByName("imageMode")].find(r => r.checked)?.value;

      if (!title) {
        alert("ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      if (!accessToken) {
        alert("âŒ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. login.htmlì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        return;
      }

      const blogId = await getBlogId(accessToken);
      const linkInputs = [...linkListDiv.querySelectorAll(".link-group")];
      let contentHtml = "";
      let videoUrls = [];

      for (const group of linkInputs) {
        const type = group.dataset.type;
        const url = group.querySelector("input").value.trim();
        if (!url) continue;

        if (type === "image") {
          contentHtml += getImageHtml(url, imageMode);
        } else {
          videoUrls.push(url);
        }
      }

      if (videoUrls.length > 0) {
        contentHtml += getVideoHtml(videoUrls, videoMode, manualThumb);
      }

      const postData = { title: title, content: contentHtml };

      const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(postData)
      });

      const result = await res.json();
      if (result.id) {
        document.getElementById("postStatus").innerHTML =
          `âœ… ê²Œì‹œ ì„±ê³µ! <a href="${result.url}" target="_blank">ğŸ”— ê²Œì‹œë¬¼ ë³´ê¸°</a>`;
      } else {
        document.getElementById("postStatus").innerText = "âŒ ê²Œì‹œ ì‹¤íŒ¨";
        console.error(result);
      }
    }

    updateUI();
  </script>
</body>
</html>
