<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Blogger 포스팅 도구</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input, select { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>📤 Blogger 자동 포스팅</h2>

  <label>제목:</label><br>
  <input id="postTitle" placeholder="게시물 제목" style="width: 400px;"><br><br>

  <label>종류 선택:</label><br>
  <input type="radio" name="mediaType" value="image" checked> 이미지
  <input type="radio" name="mediaType" value="video"> 동영상<br><br>

  <div id="imageOptions">
    <label>이미지 방식:</label><br>
    <input type="radio" name="imageMode" value="original" checked> 원본 링크
    <input type="radio" name="imageMode" value="imgur"> Imgur 변환<br><br>
  </div>

  <div id="videoOptions" style="display:none;">
    <label>동영상 방식:</label><br>
    <input type="radio" name="videoMode" value="original" checked> 원본 링크
    <input type="radio" name="videoMode" value="imgur"> Imgur 변환<br><br>
  </div>

  <label>링크 입력 (여러 줄 가능):</label><br>
  <textarea id="mediaUrls" rows="6" cols="60" placeholder="https://example.com/abc.mp4 또는 https://imgur.com/abc 등"></textarea><br>

  <button onclick="createBloggerPost()">📝 게시물 작성</button>
  <div id="postStatus" style="margin-top:20px; color:blue;"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const accessToken = params.get("token");

    const mediaTypeRadios = document.getElementsByName("mediaType");
    const videoOptions = document.getElementById("videoOptions");
    const imageOptions = document.getElementById("imageOptions");

    mediaTypeRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        const isVideo = radio.value === "video";
        videoOptions.style.display = isVideo ? "block" : "none";
        imageOptions.style.display = isVideo ? "none" : "block";
      });
    });

function getVideoHtml(url, mode) {
  let src = url.trim();
  let thumbImg = "";

  if (mode === "imgur") {
    const match = src.match(/imgur\.com\/([a-zA-Z0-9]+)/);
    if (match) {
      const code = match[1];
      src = `https://i.imgur.com/${code}.mp4`;
      thumbImg = `<p style="text-align:center; margin: 20px 0;">
                    <img src="https://i.imgur.com/${code}.jpeg" style="max-width:500px;">
                  </p>`;
    }
  } else {
    // 👇 여기 추가: 원본일 때 썸네일 자동추정
    if (src.endsWith(".mp4")) {
      const thumbUrl = src.replace(".mp4", ".jpg"); // 또는 .jpeg
      thumbImg = `<p style="text-align:center; margin: 20px 0;">
                    <img src="${thumbUrl}" style="max-width:500px;">
                  </p>`;
    }
  }

  const videoTag = `<p style="text-align:center; margin: 20px 0;">
                      <video src="${src.replace(/&/g, "&amp;")}" controls preload="metadata" muted style="max-height:500px;"></video>
                    </p>`;

  return thumbImg + videoTag;
}


    async function getBlogId(token) {
      const res = await fetch("https://www.googleapis.com/blogger/v3/users/self/blogs", {
        headers: { Authorization: "Bearer " + token }
      });
      const data = await res.json();
      return data.items[0].id;
    }

    async function createBloggerPost() {
      const title = document.getElementById("postTitle").value.trim();
      const urls = document.getElementById("mediaUrls").value.trim().split("\n").filter(line => line.trim() !== "");
      const mediaType = [...document.getElementsByName("mediaType")].find(r => r.checked).value;
      const videoMode = [...document.getElementsByName("videoMode")].find(r => r.checked)?.value;
      const imageMode = [...document.getElementsByName("imageMode")].find(r => r.checked)?.value;

      if (!title || urls.length === 0) {
        alert("제목과 링크를 모두 입력하세요.");
        return;
      }

      if (!accessToken) {
        alert("❌ 토큰이 없습니다. login.html에서 로그인해주세요.");
        return;
      }

      const blogId = await getBlogId(accessToken);
      let contentHtml = "";

      for (const url of urls) {
        if (mediaType === "image") {
          contentHtml += getImageHtml(url.trim(), imageMode);
        } else {
          contentHtml += getVideoHtml(url.trim(), videoMode);
        }
      }

      const postData = { title: title, content: contentHtml };

      const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/`, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + accessToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(postData)
      });

      const result = await res.json();

      if (result.id) {
        document.getElementById("postStatus").innerHTML =
          `✅ 게시 성공! <a href="${result.url}" target="_blank">🔗 게시물 보기</a>`;
      } else {
        document.getElementById("postStatus").innerText = "❌ 게시 실패";
        console.error(result);
      }
    }
  </script>
</body>
</html>
